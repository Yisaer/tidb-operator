apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: admission-controller-cr
  namespace: test
  labels:
    app: admission-webhook
rules:
  - apiGroups: ["apps"]
    resources: ["statefulsets"]
    verbs: ["get"]
  - apiGroups: ["pingcap.com"]
    resources: ["tidbclusters"]
    verbs: ["get"]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admission-controller-sa
  namespace: test
  labels:
    app: admission-controller
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: admission-controller-crb
  namespace: test
  labels:
    app: admission-controller
subjects:
  - kind: ServiceAccount
    name: admission-controller-sa
    namespace: test
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: admission-controller-cr
---
apiVersion: v1
kind: Service
metadata:
  name: admission-controller-svc
  namespace: test
  labels:
    app: admission-controller
spec:
  ports:
    - port: 443
      targetPort: 443
  selector:
    app: admission-controller
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: admission-controller
  namespace: test
  labels:
    app: admission-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: admission-controller
  template:
    metadata:
      labels:
        app: admission-controller
    spec:
      serviceAccountName: admission-controller-sa
      containers:
        - name: admission-controller
          image: yisa/webhook:0.0.6
          imagePullPolicy: IfNotPresent
          command:
            - /usr/local/bin/tidb-admission-controller
            - -tlsCertFile=/etc/webhook/certs/cert.pem
            - -tlsKeyFile=/etc/webhook/certs/key.pem
            - -v=2
          volumeMounts:
            - name: webhook-certs
              mountPath: /etc/webhook/certs
              readOnly: true
      volumes:
        - name: webhook-certs
          secret:
            secretName: admission-controller-certs
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: mutation-admission-contorller-cfg
  labels:
    app: admission-controller
webhooks:
  - name: pod-admission-controller.pingcap.net
    failurePolicy: Fail
    clientConfig:
      service:
        name: admission-controller-svc
        namespace: test
        path: "/pods"
      caBundle: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURqRENDQW5TZ0F3SUJBZ0lVUk5HVzVLWUVJeklnaVRFdmJmVUkzRmpoWUNVd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0ZURVRNQkVHQTFVRUF4TUthM1ZpWlhKdVpYUmxjekFlRncweE9URXdNall3TlRFM01EQmFGdzB5TURFdwpNalV3TlRFM01EQmFNQ3d4S2pBb0JnTlZCQU1USVdGa2JXbHpjMmx2YmkxamIyNTBjbTlzYkdWeUxYTjJZeTUwClpYTjBMbk4yWXpDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTlIvNm1mSDNmYVEKRHdSMjRZSi9lOVFiKzJ2VTNHM3BoNTA3ZFdhQkhhUGxaSUlkazVmTE5EYzZ1a0psNDhKWkZDTTN6ODB4ZzE3RQoyKzVmZFM3OGxUNURDek1kc2JhWUt6c213MlltU3Bkd3IzaVY5TExwZ0w4M2xwcDFPRUt5VDBnbi9LelBwTDI3CkZYNjdncnl2WW5yQlJGY0RDSFRXNkpRbitQNktsYmxwVE8yV0pBK3BNRXJacUhVRXFzQ1F2aHNldnpkVnZ6cFgKa1JtS3dZS1Jyc0g2Ly9uN2IrdVhvVFRTRFZ2RDRmWWhVdFU4bzV2c3dLVDJWeDVvSHo5QkZSWHhFU29pUHYwVApzNlBveGM2MWFJaDhJNGFWS3B5eTdSb2ErMGVSWkZBT0pZbEdWQlpmUW8zR01ldytXTXVHQk9IanZkT1loOUtaCm1ISU1vSnpBTTkwQ0F3RUFBYU9CdkRDQnVUQU9CZ05WSFE4QkFmOEVCQU1DQmFBd0V3WURWUjBsQkF3d0NnWUkKS3dZQkJRVUhBd0V3REFZRFZSMFRBUUgvQkFJd0FEQWRCZ05WSFE0RUZnUVVTRFdSR2VJak5Ud3NESGV0dHVnKwpEU3loeVZJd1pRWURWUjBSQkY0d1hJSVlZV1J0YVhOemFXOXVMV052Ym5SeWIyeHNaWEl0YzNaamdoMWhaRzFwCmMzTnBiMjR0WTI5dWRISnZiR3hsY2kxemRtTXVkR1Z6ZElJaFlXUnRhWE56YVc5dUxXTnZiblJ5YjJ4c1pYSXQKYzNaakxuUmxjM1F1YzNaak1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQkhTejErbWpDNTlCV2xtNFloQUxJYQp6L2NNSnN4L2VVaVRVVHcybXgwYkpIV1pqaUZPSlNpdmNkeHN2ZThXMGtBZUh3bnZRVS85MEllV0laa1VSVVJFCjNIMXVkM2oxNFMrdkdrbGttR0ZhTXJaWEFMRkhqZVFhL2s2T00yT3FyN01mRXdKMWVOZzdGcUR0NFoyT1ZmMGkKTFNjSnZNaE5iR0ZvaVRFejM3UDFtanpmMExlbEJzOU45eWFGMzhYbjhDV3R1aGxnQkU5ekt3cGtOeFdSa3V6cwpYRjFId1NmV1pzUjhENWJielBkcUU2UmRIbHRmRlBoRmQvaGcyamxMMmtBVU00dW11czBLWkExajFUZ2d3RDNRCkY2b2xBeHdteTRrOHFCQklYb3BsZW5GTDlLM0ZmbGpwWW94R2RGUHpmVTU1NTRFTlpBUmx1NVFnc0RYNXdJNTQKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
    rules:
      - operations: [ "CREATE" ]
        apiGroups: [ "" ]
        apiVersions: ["v1"]
        resources: ["pods"]
